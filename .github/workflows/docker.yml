# .github/workflows/build.yml
name: Build Docker Image

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push wep-backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ghcr.io/jorgellerena724/wep-backend:latest
          ghcr.io/jorgellerena724/wep-backend:${{ github.sha }}
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
        provenance: false  # Importante: desactiva para nombres custom
    
    - name: Success message
      if: github.event_name == 'push'
      run: |
        echo "========================================"
        echo "âœ… IMAGEN CONSTRUIDA EXITOSAMENTE"
        echo "========================================"
        echo ""
        echo "ðŸ“¦ Nombre imagen: ghcr.io/jorgellerena724/wep-backend:latest"
        echo "ðŸ”— URL en GHCR: https://github.com/jorgellerena724?tab=packages&repo_name=${{ github.event.repository.name }}"
        echo ""
        echo "ðŸš€ PARA DESPLEGAR MANUALMENTE EN VPS:"
        echo "1. Conectar al VPS:"
        echo "   ssh llerena@213.136.83.140 -p 2222"
        echo ""
        echo "2. Navegar al directorio:"
        echo "   cd /opt/docker/apps/wep-backend"
        echo ""
        echo "3. OpciÃ³n A - Usar script deploy:"
        echo "   ./deploy.sh"
        echo ""
        echo "3. OpciÃ³n B - Comandos manuales:"
        echo "   docker compose pull"
        echo "   docker compose down"
        echo "   docker compose up -d"
        echo "   docker compose logs --tail=20"
        echo ""
        echo "ðŸ“‹ Comando SSH completo:"
        echo "ssh llerena@213.136.83.140 -p 2222 'cd /opt/docker/apps/wep-backend && ./deploy.sh'"
        echo ""
        echo "ðŸ”„ O para solo actualizar la imagen:"
        echo "ssh llerena@213.136.83.140 -p 2222 'cd /opt/docker/apps/wep-backend && docker compose pull && docker compose up -d'"