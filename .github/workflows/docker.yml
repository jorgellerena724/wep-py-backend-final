# .github/workflows/build.yml
name: Build and Deploy Docker Image

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: jorgellerena724/wep-backend  # Nombre especÃ­fico que quieres

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push wep-backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
        provenance: false
    
    - name: Success message
      if: github.event_name == 'push'
      run: |
        echo "========================================"
        echo "âœ… IMAGEN CONSTRUIDA EXITOSAMENTE"
        echo "========================================"
        echo ""
        echo "ğŸ“¦ Imagen: ghcr.io/jorgellerena724/wep-backend:latest"
        echo "ğŸ”— URL en GHCR: https://github.com/jorgellerena724?tab=packages&repo_name=${{ github.event.repository.name }}"
        echo ""
        echo "ğŸš€ PARA DESPLEGAR EN VPS:"
        echo "1. Conectar al VPS:"
        echo "   ssh llerena@213.136.83.140 -p 2222"
        echo ""
        echo "2. Ejecutar deploy:"
        echo "   cd /opt/docker/apps/wep-backend"
        echo "   ./deploy.sh"
        echo ""
        echo "ğŸ“‹ Comando completo:"
        echo "ssh llerena@213.136.83.140 -p 2222 'cd /opt/docker/apps/wep-backend && ./deploy.sh'"

  deploy-vps:
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup SSH key
      env:
        SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 2222 213.136.83.140 >> ~/.ssh/known_hosts
    
    - name: Execute deployment on VPS
      env:
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸš€ Desplegando en VPS..."
        
        # Comando SSH para ejecutar el despliegue
        ssh -o StrictHostKeyChecking=no -p 2222 llerena@213.136.83.140 "
          set -e
          echo 'ğŸ“‚ Cambiando al directorio del proyecto...'
          cd /opt/docker/apps/wep-backend
          
          echo 'ğŸ” Login en GHCR (si es necesario)...'
          if [ -f ~/.docker/config.json ]; then
            echo 'âœ“ Docker ya estÃ¡ autenticado'
          else
            echo 'âš ï¸  Necesitas configurar docker login en el VPS:'
            echo 'docker logout ghcr.io'
            echo 'echo \"TU_GITHUB_TOKEN\" | docker login ghcr.io -u jorgellerena724 --password-stdin'
          fi
          
          echo 'ğŸ“¥ Pulling latest image...'
          docker compose pull
          
          echo 'ğŸ”„ Reiniciando contenedor...'
          docker compose up -d --remove-orphans
          
          echo 'â³ Esperando que el contenedor estÃ© listo...'
          sleep 5
          
          echo 'ğŸ“Š Estado del contenedor:'
          docker compose ps
          
          echo 'ğŸ“ Ãšltimos logs:'
          docker compose logs --tail=10
          
          echo 'âœ… Despliegue completado!'
        "
        
        echo "ğŸ‰ Despliegue ejecutado con Ã©xito!"